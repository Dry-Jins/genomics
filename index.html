<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Gene View</title>
    <meta name="author" content="SkyJin">
    <link href="js/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="js/bootstrap-fileinput/css/fileinput.min.css" rel="stylesheet">
    <link href="js/bootstrap-toggle/css/bootstrap-toggle.min.css" rel="stylesheet">
    <link href="js/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <link href="js/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="js/jquery-ui/themes/base/jquery-ui.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">
    <link rel="stylesheet" href="stylesheets/select.css">
    <link rel="stylesheet" href="stylesheets/d3-context-menu.css">
    <style>
        .thumbnail .caption{
            padding: 1px;
        }
        #content-list {
            list-style-type: none;
        }

        .fixed-block {
            overflow-y: scroll;
            overflow-x: hidden;
        }

        .scrollable {
            overflow-y: scroll;
        }

        .canvas-popup {
            position: absolute;
            display: none;
        }

        .popup {
            position: absolute;
            left: 0;
            top: 0;
            background-color: #fff;
            border: 1px #ccc solid;
            border-radius: 6px;
            box-shadow: #333 2px 2px 4px;
            padding: 8px;
            font-family: arial, helvetica, sans-serif;
            display: block;
        }

        #tooltip {
            position: absolute;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        #tooltip.hidden {
            display: none;
        }

        rect.bordered {
            stroke: #E6E6E6;
            stroke-width: 2px;
        }

        .graph-node text {
            pointer-events: none;
            font: 5px sans-serif;
        }

        .toggle.ios, .toggle-on.ios, .toggle-off.ios {
            border-radius: 20px;
        }

        .toggle.ios .toggle-handle {
            border-radius: 20px;
        }

        .block {
            line-height: 34px;
        }

        .block a:link {
            text-decoration: none;
        }

        .block-display {

        }

        .panel-title {
            line-height: 34px;
        }

        .node circle {
            fill: #999;
        }

        .node text {
            font: 10px sans-serif;
        }

        .node--internal circle {
            fill: #555;
        }

        .node--internal text {
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }

        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.4;
            stroke-width: 1.5px;
        }

        .link--active {
            stroke: #000 !important;
            stroke-width: 1.5px;
        }

        .link-extension--active {
            stroke-opacity: .6;
        }

        .d3-tip {
            line-height: 1;
            padding: 6px;
            background: #101010;
            border-radius: 2px;
            pointer-events: none;
        }

        .d3-tip-rect {
            font-size: small;
        }

        .d3-tip-value {
            color: aliceblue !important;
        }

        .block-title {
        }
    </style>

</head>
<body>
<div id="tooltip">
</div>
<nav class="navbar navbar-inverse" role="navigation" style="z-index: 99">
    <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse"
                data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span
                class="icon-bar"></span><span class="icon-bar"></span>
        </button>
        <a class="navbar-brand btn-toggle-menu" href="#" onclick="blockManager.addBlock();" style="color: #FFF"><i
                class="glyphicon glyphicon-plus-sign"></i></a>
    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li class="active">
                <a href="#">Gene Block</a>
            </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
            <li>
                <a href="#">Network </a>
            </li>
            <li>
                <a href="#">Frequency </a>
            </li>
            <!--
            <li class="dropdown">
                <a class="dropdown-toggle" href="#" data-toggle="dropdown">Dropdown<strong class="caret"></strong></a>
                <ul class="dropdown-menu">
                    <li>
                        <a href="#">Action</a>
                    </li>
                    <li>
                        <a href="#">Another action</a>
                    </li>
                    <li>
                        <a href="#">Something else here</a>
                    </li>
                    <li class="divider">
                    </li>
                    <li>
                        <a href="#">Separated link</a>
                    </li>
                </ul>
            </li>
            -->
        </ul>
    </div>

</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 main" id="content">
            <div id="content-list"></div>
        </div>
        <!--
        <div class="col-md-9 network-panel">
            <div class="panel panel-default ">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Network
                    </h3>
                </div>
                <div class="panel-body network-block">
                    <svg id="network-edge"></svg>
                </div>
            </div>
        </div>
        <div class="col-md-3 frequency-panel">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Frequency
                        <div class="pull-right" style="inline">
                            <input type="checkbox" checked data-toggle="toggle" data-on="Table" data-off="Bar Chart"
                                   data-onstyle="primary" data-offstyle="danger" data-size="small" data-style="ios"
                                   id="toggle_bar_table">
                        </div>
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="bar-graph"></div>
                    <div class="bar-table" style="display: none">
                        <table class="table table-bordered table-striped">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel-footer">
                </div>
            </div>
        </div>
        -->
    </div>

</div>

<script src="js/jquery/dist/jquery.min.js"></script>
<script src="js/jquery-ui/jquery-ui.min.js"></script>
<script src="js/jquery-ui/resize.js"></script>
<script src="js/lodash/dist/lodash.min.js"></script>
<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="js/bootstrap-fileinput/js/fileinput.min.js"></script>
<script src="js/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
<script src="js/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>
<script src="js/d3/d3.min.js"></script>
<script src="js/d3/d3-selection-multi.min.js"></script>
<script src="js/d3-tip/index.js"></script>
<script src="js/d3-context-menu/js/d3-context-menu.js"></script>
<script src="js/babel/browser.min.js"></script>
<script src="js/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="js/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="js/geromicsdata.js"></script>
<script type="text/javascript" src="js/geromicscoldata.js"></script>
<script type="text/javascript" src="js/subgeromicsdata.js"></script>
<script type="text/javascript" src="js/subgeromicscoldata.js"></script>
<script type="text/javascript" src="js/currentInfo.js"></script>
<script>
    // TODO 1.1 히트맵 + 클러스터 그래프
    // TODO 1.1.1  동적 D3 블록 그래프 크기 조정
    // TODO 1.2. frequency Bar 그래프
    // TODO 1.3. 네트워크 그래프
    var test;
    // Visualization 담당 스크립트


    var visualizer = {
        createTaperedNetworkGraph: function (svg) {
            console.log(svg);
            if (svg == undefined)
                svg = d3.select("#network-edge");

            var width = window.innerWidth / 3;
            var height = 529;
            //svg.attr("viewBox", "0 0 " + width + " " + height);
            svg.attr("width", width);
            svg.attr("height", height);
            svg.attr('class','popup-svg');
            //svg = svg.append('g');


            var simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(function (d) {
                        return d.id;
                    }))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("charge", d3.forceManyBody().distanceMax([130]));

            d3.json("network.json", function (error, graph) {
                if (error) throw error;

                var bothLinks = _.intersectionWith(_.cloneDeep(graph.links), _.map(_.cloneDeep(graph.links), function (item, idx) {
                    return {source: item.target, target: item.source};
                }), _.isEqual);

                graph.links = _.map(graph.links, function (item, idx) {
                    //console.log(item);
                    if (_.find(bothLinks, item)) {
                        item.both = true;
                    }
                    return item;
                });

                var link = svg
                        .selectAll("path")
                        .data(graph.links)
                        .enter().append("path")
                        .attr("class", "graph-edge")
                        .style("fill", "darkgreen")
                        .style("stroke", function (d) {
                            return d.both ? "#0028FF" : "black";
                        })
                        .style("stroke-width", function (d) {
                            return d.both ? 5 : 1;
                        })
                        .style("opacity", 0.75);

                var gnodes = svg
                        .selectAll("g")
                        .data(graph.nodes)
                        .enter()
                        .append("g")
                        .attr("class", "gnodes")
                        .call(d3.drag()
                                .on("start", dragstarted)
                                .on("drag", dragged)
                                .on("end", dragended));


                var node = gnodes
                        .attr("class", "graph-node")
                        .append("circle")
                        .attr("r", 4.5).attr("fill", "#333");

                var labels = gnodes.append("text")
                        .attr("dx", "-10")
                        .attr("dy", "-10")
                        .text(function (d) {
                            return d.name;
                        });

                var titles = gnodes.append("title")
                        .text(function (d) {
                            return d.id;
                        });

                simulation
                        .nodes(graph.nodes)
                        .on("tick", ticked);

                simulation.force("link")
                        .links(graph.links);

                function ticked() {
                    link
                            .attr("x1", function (d) {
                                return d.source.x;
                            })
                            .attr("y1", function (d) {
                                return d.source.y;
                            })
                            .attr("x2", function (d) {
                                return d.target.x;
                            })
                            .attr("y2", function (d) {
                                return d.target.y;
                            })
                            .attr("d", function (d) {
                                //console.log(d)
                                return d.both ? linkLine(d) : comet(d, 5);
                            })
                            .style("fill", "gold");

                    gnodes.attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });


                    function comet(d, nodeSize) {
                        var diffX = d.target.y - d.source.y;
                        var diffY = d.target.x - d.source.x;

                        var angle0 = ( Math.atan2(diffY, diffX) + ( Math.PI / 2 ) );
                        var angle1 = angle0 - ( Math.PI / 2 );
                        var angle2 = angle0 + ( Math.PI / 2 );

                        var x1 = d.target.x + (nodeSize * Math.cos(angle1));
                        var y1 = d.target.y - (nodeSize * Math.sin(angle1));
                        var x2 = d.target.x + (nodeSize * Math.cos(angle2));
                        var y2 = d.target.y - (nodeSize * Math.sin(angle2));

                        return "M" + x1 + "," + y1 + "L" + x2 + "," + y2 + " L " + d.source.x + "," + d.source.y + "z";
                    }

                    function linkLine(d) {
                        return "M" + d.target.x + " " + d.target.y + " L " + d.source.x + "," + d.source.y + "z";
                    }
                }
            });

            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        },
        createNetworkGraph: function () {
            var width = $("div.network-block").width();
            var height = 600;
            var $canvas = $('<canvas>').attr('width', width).attr('height', height).addClass('network');
            $('div.network-block').empty()
                    .append($canvas);
            // 네트워크 그래프
            var canvas = document.querySelector('canvas.network'),
                    context = canvas.getContext("2d"),
                    width = canvas.width,
                    height = canvas.height;

            var simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(function (d) {
                        return d.id;
                    }))
                    .force("charge", d3.forceManyBody())
                    .force("center", d3.forceCenter(width / 2, height / 2));

            function resize() {
                var width = $("div.network-block").width();
                $canvas.width(width);
                simulation.force("center", d3.forceCenter(width / 2, height / 2));
                simulation.restart();
            }

            function load() {
                d3.json("sample.json", function (error, graph) {
                    if (error) throw error;

                    simulation
                            .nodes(graph.nodes)
                            .on("tick", ticked);

                    simulation.force("link")
                            .links(graph.links);

                    d3.select(canvas)
                            .call(d3.drag()
                                    .container(canvas)
                                    .subject(dragsubject)
                                    .on("start", dragstarted)
                                    .on("drag", dragged)
                                    .on("end", dragended));

                    function ticked() {
                        context.clearRect(0, 0, width, height);

                        context.beginPath();
                        graph.links.forEach(drawLink);
                        context.strokeStyle = "#aaa";
                        context.stroke();

                        context.beginPath();
                        graph.nodes.forEach(drawNode);
                        context.fill();
                        context.strokeStyle = "#fff";
                        context.stroke();
                    }

                    function dragsubject() {
                        return simulation.find(d3.event.x, d3.event.y);
                    }
                });
            }

            function dragstarted() {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d3.event.subject.fx = d3.event.subject.x;
                d3.event.subject.fy = d3.event.subject.y;
            }

            function dragged() {
                d3.event.subject.fx = d3.event.x;
                d3.event.subject.fy = d3.event.y;
            }

            function dragended() {
                if (!d3.event.active) simulation.alphaTarget(0);
                d3.event.subject.fx = null;
                d3.event.subject.fy = null;
            }

            function drawLink(d) {
                context.moveTo(d.source.x, d.source.y);
                context.lineTo(d.target.x, d.target.y);
            }

            function drawNode(d) {
                context.moveTo(d.x + 3, d.y);
                context.arc(d.x, d.y, 3, 0, 2 * Math.PI);
                context.fillText(d.id, d.x + 10, d.y + 3);
            }

            load();
            $(window).resize(resize);
        },
        createBarGraph: function () {
            // set the dimensions and margins of the graph
            var margin = {top: 20, right: 20, bottom: 30, left: 40},
                    width = $("div.bar-graph").parent().width() - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

            // set the ranges
            var x = d3.scaleLinear()
                    .range([0, width]);

            var y = d3.scaleBand()
                    .range([height, 0])
                    .padding(0.3);

            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("div.bar-graph").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");

            // get the data
            d3.csv("scale.csv", function (error, data) {
                if (error) throw error;

                // format the data
                data.forEach(function (d) {
                    d.count = +d.count;
                });

                // Scale the range of the data in the domains
                y.domain(data.map(function (d) {
                    return d.gene;
                }));
                x.domain([0, d3.max(data, function (d) {
                    return d.count;
                })]);

                // append the rectangles for the bar chart
                svg.selectAll(".bar")
                        .data(data)
                        .enter().append("rect")
                        .attr("class", "bar")
                        .attr("y", function (d) {
                            return y(d.gene);
                        })
                        .attr("height", y.bandwidth())
                        .attr("x", function (d) {
                            return 0
                        })
                        .attr("width", function (d) {
                            return x(d.count);
                        })
                        .attr("fill", function (d) {
                            return "rgb(0, 0, " + (d.count * 5) + ")";
                        });

                // add the x Axis
                svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));

                // add the y Axis
                svg.append("g")
                        .call(d3.axisLeft(y));

                visualizer.createBarTable(data);
            });
        },
        createBarTable: function (data) {
            var table = d3.select("div.bar-table > table");
            var thead = table.select('thead');
            var tbody = table.select('tbody');

            var cols = d3.keys(data[0]);
            // 헤더 설정
            thead.append('tr')
                    .selectAll('th')
                    .data(cols)
                    .enter()
                    .append('th')
                    .text(function (cols) {
                        return cols;
                    });

            // 테이블 행 생성
            var rows = tbody.selectAll('tr').data(data).enter().append('tr');

            var cells = rows.selectAll("td")
                    .data(function (row) {
                        return cols.map(function (column) {
                            return {column: column, value: row[column]};
                        });
                    })
                    .enter()
                    .append("td")
                    .html(function (d) {
                        return d.value;
                    });
            $('div.bar-table > table').DataTable(
                    {info: false, paging: false, dom: 'f<"clear">'}
            );
            return table;
        },
        createHeatmap: function (data, cols, rows, blockId, name) {
            var basicUrl = "geromics/";

            var treeId = blockId + "-tree";
            var colTreeId = blockId + "-colTree";
            var heatmapId = blockId + "-heatmap";
            // Main createHeatmap SVG Information
            var heatmapRow;
            var heatmapRects;
            //var currentColor, currentData, currentCols, currentRows, currentCluster;

            var legendWidth = 150,
                    legendHeight = 400,
                    padding = 5;

            colorArr = ["#00ff00", "#000000", "#ff0000"];
            colorScale = d3.scaleLinear()
                    .domain([minData, 0, maxData])
                    .range(colorArr);
            currentColor = colorScale;

            var div = d3.select('#legendSvg'),
                    legendSvg = div.append('svg').data(colorScale.domain());
            legendSvg.attr('width', legendWidth).attr('height', legendHeight);
            // Create the svg:defs element and the main gradient definition.
            var svgDefs = legendSvg.append('defs');
            var mainGradient = svgDefs.append('linearGradient')
                    .attr('id', 'mainGradient').attr("x1", "0%").attr("y1", "0%").attr("x2", "0%").attr("y2", "100%");

            //height of each row in the createHeatmap
            var h = 50;
            //width of each column in the createHeatmap
            var w = 50;
            //attach a SVG node to the document
            //height and width defined by the row/column lengths
            var width = (w * singlecols.length) + 100;
            //d3.select("body").append("div").attr("id","createHeatmap");
            var loadContent = [];
            // Main Row Tree SVG Information
            var treeWidth = (w * singlecols.length), treeHeight = h * singlerows.length;
            // Main Column Tree SVG Information
            var colTreeWidth = width - 25, colTreeHeight = 80;
            d3.select("#" + blockId).select("div.block-display").html("");
            var mySVG = d3.select("#" + blockId).select("div.block-display")
                    .append("svg")
                    .attr("width", "100%");
            //.attr("viewBox", "0 0 900 1100")

            var heatmapG = mySVG.append('g')
                    .attr("transform", "translate(410, 50)")
                    .attr("id", heatmapId)
                    .on('mouseover', function (d, i) {
                        heatmapG.classed('state', true);
                    }).on('mouseout', function (d, i) {
                        heatmapG.classed('state', false);
                    });
            //.attr("transform", "translate(500, 0)")
            var colTreeG = mySVG
                    .append("g")
                    .attr("id", colTreeId)
                    .attr("transform", "translate(580, 0)")
            //.attr("width", colTreeWidth)
            //.attr("height", colTreeHeight)
            //.attr("transform", "translate(-100, 0)")
            var treeG = mySVG
                    .append("g")
                    .attr("id", treeId)
                    .attr("transform", "translate(20, 2250)")

            //.attr("width", treeWidth)

            //.attr("transform", "translate(40, 0)");
            //generate the Heatmap
            heatmapRow = heatmapG.selectAll(".heatmap")
                    .data(data)
                    .enter().append("g");

            // Draw the Heatmap
            var tip = d3.tip().attr('class', 'd3-tip').html(function (d) {
                return "<div class='d3-tip-rect'>" +
                        "<span> SOURCE : " + completecols[d[2]] + "</span><br>" +
                        "<span> GENE : <span class='d3-tip-value'>" + completerows[d[1]] + "</span></span><br>" +
                        "<span> VALUE : " + d[0] + "</span>" +
                        "</div>";
            });

            heatmapRects = heatmapRow
                    .selectAll(".rect")
                    .data(function (d) {
                        return d;
                    }).enter().append("svg:rect")
                    .attr('width', w)
                    .attr('height', h)
                    .attr('x', function (d) {
                        return (d[2] * w) + 75;
                    })
                    .attr('y', function (d) {
                        return (d[1] * h) + 50;

                    })
                    .attr('rx', 5)
                    .attr('ry', 5)
                    .attr('class', 'bordered')
                    .style('fill', function (d) {
                        return colorScale(d[0]);
                    })
                    .call(tip)
                    .on("click", function (d, i) {
                        console.log(this);
                        if (!d3.event.ctrlKey) {
                            d3.selectAll('rect.selected').classed("selected", false);
                        }
                    })
                    .on('mouseover', function (e) {
                        tip.show(e);
                        $(this).css({
                            'stroke': '#eee',
                            'stroke-width': '12px'
                        });

                        var xPosition = parseFloat(d3.select(this).attr('x')) + w / 2;
                        var yPosition = parseFloat(d3.select(this).attr('y')) / 2 + h / 2;

                        var zoomTip = d3.select('#tooltip')
                                .style({
                                    left: xPosition + 'px',
                                    top: yPosition + 'px'
                                });
                        //var svgClone = heatmapG.clone();
                        //zoomTip.append(svgClone);
                        //zoomTip.classed('hidden', false);

                    })
                    .on('mouseout', function (e) {
                        $(this).css({
                            'stroke': '#E6E6E6',
                            'stroke-width': '2px'
                        });
                        tip.hide(e);
                        //console.log('mouseout', d3.event);
                        if (d3.event.relatedTarget != null && d3.event.relatedTarget.tagName == 'HTML') {
                            // remove selection frame
                            heatmapG.selectAll("rect.selection").remove();

                            // remove temporary selection marker class
                            d3.selectAll('g.state.selection').classed("selection", false);
                        }
                    }).on("mousedown", function (d, i, data) {
                        if (!d3.event.ctrlKey) {
                            d3.selectAll('g.selected').classed("selected", false);
                        }
                        else {
                            var e = d3.event,
                                    g = this,
                                    isSelected = d3.select(g).classed("selected");
                            d3.select(g).classed("selected", !isSelected);
                            // reappend dragged element as last
                            // so that its stays on top
                            g.parentNode.appendChild(g);
                        }
                        var p = d3.mouse(this);
                        if (!d3.event.shiftKey) return;
                        heatmapG.append("rect")
                                .attrs({
                                    rx: 6,
                                    ry: 6,
                                    x: p[0],
                                    y: p[1],
                                    width: 0,
                                    height: 0
                                }).attr('class', 'selection')
                    })
                    .on("mousemove", function () {
                        if (!d3.event.shiftKey) return;
                        var s = heatmapG.select("rect.selection");
                        if (!s.empty()) {
                            var p = d3.mouse(this),
                                    d = {
                                        x: parseInt(s.attr("x"), 10),
                                        y: parseInt(s.attr("y"), 10),
                                        width: parseInt(s.attr("width"), 10),
                                        height: parseInt(s.attr("height"), 10)
                                    },
                                    move = {
                                        x: p[0] - d.x,
                                        y: p[1] - d.y
                                    };
                            //console.log(p);

                            if (move.x < 1 || (move.x * 2 < d.width)) {
                                d.x = p[0];
                                d.width -= move.x;
                                if (d.width < 0) d.width -= d.width;
                            } else {
                                d.width = move.x;
                                if (d.width < 0) d.width -= d.width;
                            }

                            if (move.y < 1 || (move.y * 2 < d.height)) {
                                d.y = p[1];
                                d.height -= move.y;
                                if (d.height < 0) d.height -= d.height;
                            } else {
                                d.height = move.y;
                                if (d.height < 0) d.height -= d.height;
                            }
                            s.attrs(d);

                            // deselect all temporary selected state objects
                            d3.selectAll('g.state.selection.selected').classed("selected", false);
                            d3.select('g.state').selectAll('rect').nodes().forEach(function (state_data, i) {
                                var rect = d3.select(state_data);
                                var x = rect.attr('x');
                                var y = rect.attr('y');
                                if (
                                        !d3.select(state_data).classed("selected") &&
                                        // inner rect inside selection frame
                                        x <= d.x + d.width && x >= d.x - w &&
                                        y <= d.y + d.height && y >= d.y - h
                                ) {
                                    d3.select(state_data)
                                            .classed("selected", true);
                                }
                            });
                        }
                    })
                    .on("mouseup", function () {
                        // remove selection frame
                        heatmapG.selectAll("rect.selection").remove();
                        if (d3.event.ctrlKey || d3.event.shiftKey) {
                            var blockId = d3.select('g.state').attr('id');
                            var selection = d3.selectAll('rect.selected').data().map(function (d, i, data) {
                                return {source: completecols[d[2]], gene: completerows[d[1]], value: d[0]}
                            });
                            var obj = {id: blockId, selection: selection};
                            console.log(obj);
                            alert(JSON.stringify(obj));

                        }
                    });

            var contextMenuShowing = false;
            heatmapG.on('contextmenu', function (d, i, self) {
                if (contextMenuShowing) {
                    d3.event.preventDefault();
                    d3.select('.popup-svg').selectAll("*").remove();
                    d3.select('.canvas-popup').classed('popup',false);
                    contextMenuShowing = false;
                } else {
                    if (d3.event.ctrlKey) return;
                    d3_target = d3.select(d3.event.target);
                    d3.event.preventDefault();
                    var $menuSelector = $('#contextMenu');
                    console.log(this);
                    var mousePosition = d3.mouse(d3.select('body').node());
                    $menuSelector.show().css({
                        left: mousePosition[0] + 10 + 'px',
                        top: mousePosition[1] + 10 + 'px'
                    });
                    $menuSelector.find('a.context-menu-pathway').on('click', function (e) {
                        if (d3_target.classed("selected")) {
                            contextMenuShowing = true;
                            d = d3_target.datum();
                            // Build the popup
                            $('.canvas-popup').css({"left": mousePosition[0]+50
                                    ,"top": mousePosition[1]}).addClass('popup');
                            var popup = d3.select(".canvas-popup").select("svg").classed('popup-svg',true);
                            visualizer.createTaperedNetworkGraph(popup);
                            $menuSelector.hide();
                        }
                    });

                }
            });


            mySVG.attr("viewBox", "0 0 700 " + (treeHeight + 110));

            //label columns (Condition name)
            var columnLabel = heatmapG.selectAll(".colLabel")
                    .data(cols)
                    .enter().append('svg:text')
                    .attr('x', function (d, i) {
                        return ((i + 0.5) * w + 75);
                    })
                    .attr('y', function (d, i) {
                        return 30;
                    })
                    .attr('class', 'label')
                    .style('text-anchor', 'middle')
                    .text(function (d) {
                        return d;
                    });

            columnLabel
                    .on("mouseover", function () {
                        d3.select(this).style("font-weight", "bold").style("font-size", "18")
                    })
                    .on("mouseout", function () {
                        d3.select(this).style("font-weight", "").style("font-size", "12")
                    });


            //label row (Gene name)
            var rowLabel = heatmapG.selectAll(".rowLabel")
                    .data(rows)
                    .enter().append('svg:text')
                    .attr('x', -15)
                    .attr('y', function (d, i) {
                        return (i * h) + 80
                    })
                    .attr('class', 'label')
                    .style('text-anchor', 'right')
                    .text(function (d) {
                        return d;
                    });

            rowLabel
                    .on("mouseover", function () {
                        d3.select(this).style("font-weight", "bold").style("font-size", "18")
                    })
                    .on("mouseout", function () {
                        d3.select(this).style("font-weight", "").style("font-size", "12")
                    });

            visualizer.makeTree(currentCluster, treeId, "tree", treeHeight);
            visualizer.makeColTree(currentCluster, colTreeId, "main", colTreeWidth);
        },
        makeTree: function (clusterName, treeId, treeType, makeTreeHeight) {
            var g = d3.select("#" + treeId);
            console.log(makeTreeHeight);
            var tree = d3.cluster()
            //.size([makeTreeHeight,320])
                    .nodeSize([50, 25])
                    .separation(separation);

            function separation(a, b) {
                return a.parent == b.parent ? 1 : 1;
            }

            //This code help to find the parent id in this hierarchy, so change this part.
            var stratify = d3.stratify().parentId(function (d) {
                return d.id.substring(0, d.id.lastIndexOf("."));
            });
            var path = "";
            if (treeType == "tree") {
                path = blockManager.basicUrl + "static/csv/" + clusterName + "tree.csv";
            } else if (treeType == "subTree") {
                path = blockManager.basicUrl + "static/csv/subtree.csv";
            }
            //console.log(path);

            d3.csv(path, function (error, data) {
                //console.log("#"+treeId);
                if (error) throw error;

                var root = stratify(data);
                tree(root);

                var link = g.selectAll(".link").data(root.descendants().slice(1))
                        .enter().append("path").attr("class", "link").attr("d", function (d) {
                            return "M" + d.y + "," + d.x
                                    + " L " + d.parent.y + " " + d.x + " L " + d.parent.y + " " + d.parent.x;

                        });

                link
                        .on("mouseover", function (d, i) {
                            d3.select(d3.select(this)._groups[0][0]).style("stroke", "black").style("stroke-width", 2)
                        })
                        .on("mouseout", function () {
                            d3.select(this).style("stroke", "").style("stroke-width", "")
                        });


                var node = g.selectAll(".node")
                        .data(root.descendants())
                        .enter().append("g")
                        .attr("class", function (d) {
                            return "node" + (d.children ? " node--internal" : " node--leaf");
                        })
                        .attr("transform", function (d) {
                            return "translate(" + d.y + "," + d.x + ")";
                        })

                node.append("circle").attr("r", 2.5)
                        .attr("id", "node")
                        .on("mouseover", function (d) {
                            d3.select(this).attr("r", 5)
                        })
                        .on("mouseout", function () {
                            d3.select(this).attr("r", 2.5)
                        })
                        .on("click", function (d) {
                            subSVG.selectAll("g").remove();
                            subSVG.selectAll("text").remove();
                            var smallHeatmapURL = basicUrl + "subcreateHeatmap.html";
                            var id = d.id.substring(d.id.lastIndexOf(".") + 1);
                            smallHeatmapURL = smallHeatmapURL + "?nodeId=" + id + "&length=" + rowlength + "&clusterName=" + clusterName;

                            var httpRequest;
                            if (window.XMLHttpRequest) { // 모질라, 사파리등 그외 브라우저, ...
                                httpRequest = new XMLHttpRequest();
                            } else if (window.ActiveXObject) { // IE 8 이상
                                httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
                            }
                            httpRequest.onreadystatechange = function () {
                                if (httpRequest.readyState === 4) {
                                    visualizer.createHeatmap(subdata, subcols, subrows, subSVG, "sub");
                                }

                            };
                            httpRequest.open('GET', smallHeatmapURL);
                            console.log(smallHeatmapURL);
                            httpRequest.send();
                            location.reload();
                        });

                node.append("text").attr("dy", 3).attr("x", function (d) {
                    return d.children ? -8 : 8;
                })
                        .style("text-anchor", function (d) {
                            return d.children ? "end" : "start";
                        })
                        .text(function (d) {
                            return d.id.substring(d.id.lastIndexOf(".") + 1);
                        })
                        .on("mouseover", function () {
                            d3.select(this).style("font-weight", "bold")
                        })
                        .on("mouseout", function () {
                            d3.select(this).style("font-weight", "")
                        })
            });
        },
        makeColTree: function (clusterName, treeId, treeType, treeWidth) {
            console.log(treeId)
            console.log(treeWidth);
            if (treeType == "main") {
                var g = d3.select("#" + treeId);
                var path = blockManager.basicUrl + "static/csv/" + clusterName + "coltree.csv";
            } else if (treeType == "sub") {
                var g = d3.select("#" + treeId);
                var path = blockManager.basicUrl + "static/csv/subcoltree.csv"
            }

            var tree = d3.cluster()
                    .nodeSize([50, 25])
                    .separation(separation);

            function separation(a, b) {
                return a.parent == b.parent ? 1 : 1;
            }

            var stratify = d3.stratify().parentId(function (d) {
                return d.id.substring(0, d.id.lastIndexOf("."));
            });

            d3.csv(path, function (error, data) {
                if (error) throw error;

                var root = stratify(data);
                tree(root);
                var link = g.selectAll(".link").data(root.descendants().slice(1))
                        .enter().append("path").attr("class", "link").attr("d", function (d) {
                            return "M" + d.x + "," + d.y
                                    + " L " + d.x + " " + d.parent.y + " L " + d.parent.x + " " + d.parent.y;
                        });
            });
        }
    };
</script>

<script>
    // TODO 2.1 크러스터 정보 호출
    // TODO 2.2 Data 파일 업로드
    // TOdo 2.3 D3용 Block 데이터 호출

    // 좌측 기본 분석 메뉴 액션 핸들러
    var basicMenuHandler = {
        init: function () {
            // 메뉴 상태 초기화
        },
        toggleMenu: function () {

        },
        loadBlock: function () {
            // 서버에서 D3 용 데이터를 가져옴
        },
        uploadData: function () {
            // Ajax 파일 업로드 처리
        },
        showCluster: function () {
            // 가능한 클러스터 리스트를 서버에서 호출후 Selectbox로 생성
        },
        checkGo: function () {
            // 블록 추가 가능 여부 확인
        },
        pushGo: function () {
            // Block, Data, Cluster 정보를 바탕으로 중앙 메인 화면에 신규 D3 블록 생성
        }
    };
</script>

<script>
    // 우측 분석 메뉴 액션 핸들러
    var advanceMenuHandler = {};
</script>
<script>
    // TODO 테스트용 임시 코드
    $(document).ready(function () {
        //visualizer.createNetworkGraph();
        visualizer.createTaperedNetworkGraph();
        visualizer.createBarGraph();
        $('#toggle_bar_table').on('change', function (e) {
            $('div.bar-table').toggle();
            $('div.bar-graph').toggle();
        });
        $(function () {
            $("#content-list").sortable({
                handle: '.block-title',
                forceHelperSize: true
            });
        });
    });
    $(window).scroll(function () {
        //$('nav').animate({top: $(window).scrollTop() + "px"}, {queue: false, duration: 350});
        //$('.frequency-panel').animate({top: $(window).scrollTop() + "px"}, {queue: false, duration: 350});
        //$('div.network-panel').animate({top: $(window).scrollTop() + "px"}, {queue: false, duration: 350});
    });
</script>
<script>
    // 블록 관리
    var blockManager = {
                basicUrl: "geromics/",
                blockMap: {},
                init: function () {
                    this.blockMap = {};
                },
                delBlock: function (blockId) {
                    var $block = $('#' + blockId);
                    $block.remove();
                    delete this.blockMap[blockId];
                    return this.blockMap;
                },
                addBlock: function () {
                    // 블록 생성
                    var blockId = this.getBlockId();
                    var blockSvgId = blockId + "-svg";
                    var $block = $('<div class="col-md-3 thumbnail block display text-right">' +
                            '<div class="block-menu"><p><a href="#" class="block-title badge" style="float:left" data-toggle="tooltip" title="">' + blockId + ' </a></p>' +
                            '<p>' +
                            '<a href="#" class="fix-block"><i class="glyphicon glyphicon-pushpin"></i> </a>' +
                            '<a href="#" class="toggle-block"><i class="glyphicon glyphicon-resize-horizontal"></i> </a>' +
                            '<a href="#" class="edit-block"><i class="glyphicon glyphicon-cog"></i> </a>' +
                            '<a href="#" class="del-block"> <i class="glyphicon glyphicon-remove"></i></a></p></div>' +
                            '<div class="caption">' +
                            '<div class="block-display" style="display: none" ></div>' +
                            '<div class="block-edit">' +
                            '<p><input type="text" class="form-control" placeholder="BLOCK NAME..."></p>' +
                            '<p><label>- Cluster</label><select class="selectpicker" data-width="100%" data-style="btn-primary">' +
                            '<option>Method 1</option> <option>Method 2</option> <option>Method 3</option> </select> </p>' +
                            '<p><label>- Data</label><input id="input-folder-1" type="file"class="file"></p>' +
                            '<p><label>- Note</label><textarea class="form-control comment" rows="5" placeholder="Note..."></textarea></p>' +
                            '<p><a class="btn btn-success btn-block btn-block-done">Done</a></p>' +
                            '</div></div></div>');
                    $block.attr('id', blockId);
                    $block.find('a.del-block').on('click', function (e) {
                        blockManager.delBlock(blockId)
                    });
                    $block.find('a.fix-block').on('click', function (e) {
                        var $caption = $block.find('div.caption');
                        console.log($caption);
                        if ($caption.hasClass('fixed-block')) {
                            $caption.removeClass('fixed-block');
                            $caption.removeAttr('style');
                        }
                        else {
                            $caption.addClass('fixed-block');
                            $caption.css('height', window.innerHeight - 150 + 'px');
                        }
                    });
                    console.log($block.find('svg').get(0));

                    // Menu set
                    var $blockDisplay = $block.find('div.block-display');
                    var $blockEdit = $block.find('div.block-edit');
                    var $blockTitle = $block.find('.block-title');
                    var $blockToggle = $block.find('.toggle-block');

                    $block.find('a.fix-block').on('click', function (e) {
                        var blockHeight = $block.height();
                        console.log(blockHeight);
                    });
                    $block.find('a.btn-block-done').on('click', function (e) {
                        blockManager.selectType(currentClusterType);
                        //currentColor = colorScale;
                        //legend(colorScale);
                        visualizer.createHeatmap(currentData, currentCols, currentRows, blockId, "main");
                        //makeTree(currentCluster, "tree", treeHeight);
                        //makeColTree(currentCluster, "main");
                        var comment = $block.find('textarea').val();
                        $blockTitle.attr('title', comment);
                        $blockDisplay.toggle();
                        $blockEdit.toggle();
                    });
                    $block.find('a.edit-block').on('click', function (e) {
                        $blockDisplay.toggle();
                        $blockEdit.toggle();
                    });

                    $blockToggle.on('click', function (e) {
                                var mySvg = $block.find('svg');
                                var viewBox = mySvg.attr('viewBox');
                                var originViewBox = '0 0 700 5110';
                                var replaceViewBox = '390 100 300 5010';
                                if ($block.hasClass('only-heatmap')) {
                                    mySvg.attr('viewBox', originViewBox);
                                    $block.toggleClass('only-heatmap');
                                }
                                else {
                                    mySvg.attr('viewBox', replaceViewBox);
                                    $block.toggleClass('only-heatmap');
                                }

                            }
                    )
                    ;

                    $block.resizable({
                        containment: "#content",
                        handles: 'e',
                        minWidth: 40,
                        resize: function (event, ui) {
                             if (ui.size.width < 90) {
                                 $block.find('.label').css({'display':'none'});
                                 $block.find('.block-menu').css({'display':'none'});
                                 var replaceViewBox = '470 100 240 5010';
                                 $block.find('svg').attr('viewBox',replaceViewBox);
                             }
                             else{
                                 $block.find('.label').css({'display':'block'})
                                 $block.find('.block-menu').css({'display':'block'});
                                 var replaceViewBox = '390 100 300 5010';
                                 $block.find('svg').attr('viewBox',replaceViewBox);
                             }

                        }
                    });


                    // 화면 갱신
                    $('#content-list').append($block);
                    $block.hide().show('normal');
                    $('.selectpicker').selectpicker('refresh');
                    $("input.file").fileinput();
                    this.blockMap[blockId] = $block;

                    return $block;
                },
                getBlockId: function () {
                    // 고유 ID 부여
                    var d = new Date();
                    var t = d.getTime() + "";
                    return 'BLOCK-' + t.slice(-4);
                }
                ,
                selectType: function (clusterType) {
                    if (clusterType == "single") {
                        currentData = singledata, currentCols = singlecols, currentRows = singlerows, currentCluster = clusterType;
                    } else if (clusterType == "complete") {
                        currentData = completedata, currentCols = completecols, currentRows = completerows, currentCluster = clusterType;
                    } else if (clusterType == "average") {
                        currentData = averagedata, currentCols = averagecols, currentRows = averagerows, currentCluster = clusterType;
                    } else if (clusterType == "weighted") {
                        currentData = weighteddata, currentCols = weightedcols, currentRows = weightedrows, currentCluster = clusterType;
                    } else if (clusterType == "centroid") {
                        currentData = centroiddata, currentCols = centroidcols, currentRows = centroidrows, currentCluster = clusterType;
                    } else if (clusterType == "median") {
                        currentData = mediandata, currentCols = mediancols, currentRows = medianrows, currentCluster = clusterType;
                    } else if (clusterType == "ward") {
                        currentData = warddata, currentCols = wardcols, currentRows = wardrows, currentCluster = clusterType;
                    }
                }
            }
            ;

    function testdrag() {
        var radius = 40;

        var states = [
            {x: 43, y: 67, label: "first"},
            {x: 340, y: 150, label: "second"},
            {x: 200, y: 250, label: "third"},
            {x: 300, y: 320, label: "fourth"},
            {x: 50, y: 250, label: "fifth"},
            {x: 90, y: 170, label: "last"}
        ];

        var svg = d3.select("body")
                .append("svg")
                //.attr("viewBox", "0 0 " + 1000 + " " + 1000 )
                //.attr("preserveAspectRatio", "xMinYMin")
                .attr("width", "960px")
                .attr("height", "500px");
        console.log(svg);

        var gState = svg.selectAll("g").data(states).enter().append("g")
                .attr('class', 'state')
                .attr("transform", function (d) {
                            return "translate(" + [d.x, d.y] + ")";
                        }
                );

        console.log(gState);

        gState.append("circle").attr(
                'r', radius + 4).attr('class', 'outer');
        gState.append("circle").attr(
                'r', radius).attr('class', 'inner').on("click", function (d, i) {

            var e = d3.event,
                    g = this.parentNode,
                    isSelected = d3.select(g).classed("selected");

            if (!e.ctrlKey) {
                d3.selectAll('g.selected').classed("selected", false);
            }
            d3.select(g).classed("selected", !isSelected);
            // reappend dragged element as last
            // so that its stays on top
            g.parentNode.appendChild(g);
        }).on("mouseover", function () {
            d3.select(this).style("fill", "aliceblue");
        }).on("mouseout", function () {
            d3.select(this).style("fill", "white");
        });


        gState.append("text")
                .attr('text-anchor', 'middle'
                ).attr('y', 4)
                .text(function (d) {
                    return d.label;
                });


        gState.append("title")
                .text(function (d) {
                    return d.label;
                });

        svg
                .on("mousedown", function () {
                    if (!d3.event.ctrlKey) {
                        d3.selectAll('g.selected').classed("selected", false);
                    }

                    var p = d3.mouse(this);
                    if (!d3.event.shiftKey) return;
                    svg.append("rect")
                            .attrs({
                                rx: 6,
                                ry: 6,
                                'class': "selection",
                                x: p[0],
                                y: p[1],
                                width: 0,
                                height: 0
                            })
                })
                .on("mousemove", function () {
                    if (!d3.event.shiftKey) return;
                    var s = svg.select("rect.selection");
                    if (!s.empty()) {
                        var p = d3.mouse(this),
                                d = {
                                    x: parseInt(s.attr("x"), 10),
                                    y: parseInt(s.attr("y"), 10),
                                    width: parseInt(s.attr("width"), 10),
                                    height: parseInt(s.attr("height"), 10)
                                },
                                move = {
                                    x: p[0] - d.x,
                                    y: p[1] - d.y
                                };
                        //console.log(p);

                        if (move.x < 1 || (move.x * 2 < d.width)) {
                            d.x = p[0];
                            d.width -= move.x;
                        } else {
                            d.width = move.x;
                        }

                        if (move.y < 1 || (move.y * 2 < d.height)) {
                            d.y = p[1];
                            d.height -= move.y;
                        } else {
                            d.height = move.y;
                        }

                        s.attrs(d);

                        // deselect all temporary selected state objects
                        d3.selectAll('g.state.selection.selected').classed("selected", false);

                        d3.selectAll('g.state >circle.inner').each(function (state_data, i) {
                            if (
                                    !d3.select(this).classed("selected") &&
                                    // inner circle inside selection frame
                                    state_data.x - radius >= d.x && state_data.x + radius <= d.x + d.width &&
                                    state_data.y - radius >= d.y && state_data.y + radius <= d.y + d.height
                            ) {
                                d3.select(this.parentNode)
                                        .classed("selection", true)
                                        .classed("selected", true);
                            }
                        });
                    }
                })
                .on("mouseup", function () {
                    // remove selection frame
                    svg.selectAll("rect.selection").remove();

                    // remove temporary selection marker class
                    d3.selectAll('g.state.selection').classed("selection", false);
                })
                .on("mouseout", function () {
                    //console.log('mouseout', d3.event);
                    if (d3.event.relatedTarget != null && d3.event.relatedTarget.tagName == 'HTML') {
                        // remove selection frame
                        svg.selectAll("rect.selection").remove();

                        // remove temporary selection marker class
                        d3.selectAll('g.state.selection').classed("selection", false);
                    }
                });
    }
</script>
<div class="canvas-popup"><svg></svg></div>
<ul id="contextMenu" class="dropdown-menu" role="menu" style="display:none;position: absolute">
    <li><a tabindex="-1" class="context-menu-pathway">Pathway</a></li>
    <li><a tabindex="-1">TEST</a></li>
    <li class="divider"></li>
    <li><a tabindex="-1" href="#">Separated link</a></li>
</ul>
</body>
</html>