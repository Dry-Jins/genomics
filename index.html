<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Gene View</title>
    <meta name="author" content="SkyJin">
    <link href="js/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="js/bootstrap-fileinput/css/fileinput.min.css" rel="stylesheet">
    <link href="js/bootstrap-toggle/css/bootstrap-toggle.min.css" rel="stylesheet">
    <link href="js/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <link href="js/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="js/jquery-ui/themes/base/jquery-ui.min.css" rel="stylesheet">
    <style>
        .node circle {
            fill: #999;
        }

        .node text {
            font: 10px sans-serif;
        }

        .node--internal circle {
            fill: #555;
        }

        .node--internal text {
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }

        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.4;
            stroke-width: 1.5px;
        }

        .link--active {
            stroke: #000 !important;
            stroke-width: 1.5px;
        }

        .link-extension--active {
            stroke-opacity: .6;
        }

        .heatmap-container {
            display: table;
            overflow: auto;
            display: table-cell;
            vertical-align: middle;
        }

        .node--active text {
            font-weight: bold;
        }

        .filled {
            fill: url(#mainGradient);
        }

        .outlined {
            fill: none;
            stroke: url(#mainGradient);
            stroke-width: 4;
        }

        #demo {
            background: url(/geromics/static/img/lablogo.png) no -repeat center center;
            height: 200px;
            width: 200px;
        }

        .panel-title {
            line-height: 34px;
        }

        rect.bordered {
            stroke: #E6E6E6;
            stroke-width: 2px;
        }

        text.mono {
            font-size: 7pt;
            font-family: Consolas, courier;
            fill: #aaa;
        }

        text.axis-workweek {
            fill: #000;
        }

        text.axis-worktime {
            fill: #000;
        }

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 3px;
        }

        .node--internal text {
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }

        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.4;
            stroke-width: 1.5px;
        }

        .toggle.ios, .toggle-on.ios, .toggle-off.ios {
            border-radius: 20px;
        }

        .toggle.ios .toggle-handle {
            border-radius: 20px;
        }

        .block-display {
            position: relative;
        }

        .block.edit {
        }
    </style>

</head>
<body>
<nav class="navbar navbar-inverse" role="navigation" style="z-index: 99">
    <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse"
                data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span
                class="icon-bar"></span><span class="icon-bar"></span>
        </button>
        <a class="navbar-brand btn-toggle-menu" href="#" onclick="blockManager.addBlock();" style="color: #FFF"><i
                class="glyphicon glyphicon-plus-sign"></i></a>
    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li class="active">
                <a href="#">Gene Block</a>
            </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
            <li>
                <a href="#">Network </a>
            </li>
            <li>
                <a href="#">Frequency </a>
            </li>
            <!--
            <li class="dropdown">
                <a class="dropdown-toggle" href="#" data-toggle="dropdown">Dropdown<strong class="caret"></strong></a>
                <ul class="dropdown-menu">
                    <li>
                        <a href="#">Action</a>
                    </li>
                    <li>
                        <a href="#">Another action</a>
                    </li>
                    <li>
                        <a href="#">Something else here</a>
                    </li>
                    <li class="divider">
                    </li>
                    <li>
                        <a href="#">Separated link</a>
                    </li>
                </ul>
            </li>
            -->
        </ul>
    </div>

</nav>
<div class="container-fluid">

    <div class="row">
        <div class="col-md-12 main" id="content">
        </div>
        <div class="col-md-9 network-panel">
            <div class="panel panel-default ">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Network
                    </h3>
                </div>
                <div class="panel-body network-block">
                </div>
            </div>
        </div>
        <div class="col-md-3 frequency-panel">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Frequency
                        <div class="pull-right" style="inline">
                            <input type="checkbox" checked data-toggle="toggle" data-on="Bar Chart" data-off="Table"
                                   data-onstyle="primary" data-offstyle="danger" data-size="small" data-style="ios"
                                   id="toggle_bar_table">
                        </div>
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="bar-graph"></div>
                    <div class="bar-table" style="display: none">
                        <table class="table table-bordered table-striped">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel-footer">
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery/dist/jquery.min.js"></script>
<script src="js/jquery-ui/jquery-ui.min.js"></script>
<script src="js/lodash/dist/lodash.min.js"></script>
<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="js/bootstrap-fileinput/js/fileinput.min.js"></script>
<script src="js/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
<script src="js/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>
<script src="js/d3/d3.min.js"></script>
<script src="js/babel/browser.min.js"></script>
<script src="js/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="js/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="js/geromicsdata.js"></script>
<script type="text/javascript" src="js/geromicscoldata.js"></script>
<script type="text/javascript" src="js/subgeromicsdata.js"></script>
<script type="text/javascript" src="js/subgeromicscoldata.js"></script>
<script type="text/javascript" src="js/currentInfo.js"></script>
<script>
    // TODO 1.1 히트맵 + 클러스터 그래프
    // TODO 1.1.1  동적 D3 블록 그래프 크기 조정
    // TODO 1.2. frequency Bar 그래프
    // TODO 1.3. 네트워크 그래프
    var test;
    // Visualization 담당 스크립트
    var visualizer = {
        createNetworkGraph: function () {
            var width = $("div.network-block").width();
            var height = 600;
            var $canvas = $('<canvas>').attr('width', width).attr('height', height).addClass('network');
            $('div.network-block').empty()
                    .append($canvas);
            // 네트워크 그래프
            var canvas = document.querySelector('canvas.network'),
                    context = canvas.getContext("2d"),
                    width = canvas.width,
                    height = canvas.height;

            var simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(function (d) {
                        return d.id;
                    }))
                    .force("charge", d3.forceManyBody())
                    .force("center", d3.forceCenter(width / 2, height / 2));

            function resize() {
                var width = $("div.network-block").width();
                $canvas.width(width);
                simulation.force("center", d3.forceCenter(width / 2, height / 2));
                simulation.restart();
            }

            function load() {
                d3.json("sample.json", function (error, graph) {
                    if (error) throw error;

                    simulation
                            .nodes(graph.nodes)
                            .on("tick", ticked);

                    simulation.force("link")
                            .links(graph.links);

                    d3.select(canvas)
                            .call(d3.drag()
                                    .container(canvas)
                                    .subject(dragsubject)
                                    .on("start", dragstarted)
                                    .on("drag", dragged)
                                    .on("end", dragended));

                    function ticked() {
                        context.clearRect(0, 0, width, height);

                        context.beginPath();
                        graph.links.forEach(drawLink);
                        context.strokeStyle = "#aaa";
                        context.stroke();

                        context.beginPath();
                        graph.nodes.forEach(drawNode);
                        context.fill();
                        context.strokeStyle = "#fff";
                        context.stroke();
                    }

                    function dragsubject() {
                        return simulation.find(d3.event.x, d3.event.y);
                    }
                });
            }

            function dragstarted() {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d3.event.subject.fx = d3.event.subject.x;
                d3.event.subject.fy = d3.event.subject.y;
            }

            function dragged() {
                d3.event.subject.fx = d3.event.x;
                d3.event.subject.fy = d3.event.y;
            }

            function dragended() {
                if (!d3.event.active) simulation.alphaTarget(0);
                d3.event.subject.fx = null;
                d3.event.subject.fy = null;
            }

            function drawLink(d) {
                context.moveTo(d.source.x, d.source.y);
                context.lineTo(d.target.x, d.target.y);
            }

            function drawNode(d) {
                context.moveTo(d.x + 3, d.y);
                context.arc(d.x, d.y, 3, 0, 2 * Math.PI);
                context.fillText(d.id, d.x + 10, d.y + 3);
            }

            load();
            $(window).resize(resize);
        },
        createBarGraph: function () {
            // set the dimensions and margins of the graph
            var margin = {top: 20, right: 20, bottom: 30, left: 40},
                    width = $("div.bar-graph").parent().width() - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

            // set the ranges
            var x = d3.scaleLinear()
                    .range([0, width]);

            var y = d3.scaleBand()
                    .range([height, 0])
                    .padding(0.3);

            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("div.bar-graph").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");

            // get the data
            d3.csv("scale.csv", function (error, data) {
                if (error) throw error;

                // format the data
                data.forEach(function (d) {
                    d.count = +d.count;
                });

                // Scale the range of the data in the domains
                y.domain(data.map(function (d) {
                    return d.gene;
                }));
                x.domain([0, d3.max(data, function (d) {
                    return d.count;
                })]);

                // append the rectangles for the bar chart
                svg.selectAll(".bar")
                        .data(data)
                        .enter().append("rect")
                        .attr("class", "bar")
                        .attr("y", function (d) {
                            return y(d.gene);
                        })
                        .attr("height", y.bandwidth())
                        .attr("x", function (d) {
                            return 0
                        })
                        .attr("width", function (d) {
                            return x(d.count);
                        })
                        .attr("fill", function (d) {
                            return "rgb(0, 0, " + (d.count * 5) + ")";
                        });

                // add the x Axis
                svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));

                // add the y Axis
                svg.append("g")
                        .call(d3.axisLeft(y));

                visualizer.createBarTable(data);
            });
        },
        createBarTable: function (data) {
            var table = d3.select("div.bar-table > table");
            var thead = table.select('thead');
            var tbody = table.select('tbody');

            var cols = d3.keys(data[0]);
            // 헤더 설정
            thead.append('tr')
                    .selectAll('th')
                    .data(cols)
                    .enter()
                    .append('th')
                    .text(function (cols) {
                        return cols;
                    });

            // 테이블 행 생성
            var rows = tbody.selectAll('tr').data(data).enter().append('tr');

            var cells = rows.selectAll("td")
                    .data(function (row) {
                        return cols.map(function (column) {
                            return {column: column, value: row[column]};
                        });
                    })
                    .enter()
                    .append("td")
                    .html(function (d) {
                        return d.value;
                    });
            $('div.bar-table > table').DataTable(
                    {info: false, paging: false, dom: 'f<"clear">'}
            );
            return table;
        },
        createHeatmap: function (data, cols, rows, blockId, name) {
            var basicUrl = "geromics/";

            var treeId = blockId + "-tree";
            var colTreeId = blockId + "-colTree";
            var heatmapId = blockId + "-heatmap";
            // Main createHeatmap SVG Information
            var heatmapRow;
            var heatmapRects;
            //var currentColor, currentData, currentCols, currentRows, currentCluster;

            var legendWidth = 150,
                    legendHeight = 400,
                    padding = 5;

            colorArr = ["#00ff00", "#000000", "#ff0000"];
            colorScale = d3.scaleLinear()
                    .domain([minData, 0, maxData])
                    .range(colorArr);
            currentColor = colorScale;

            var div = d3.select('#legendSvg'),
                    legendSvg = div.append('svg').data(colorScale.domain());
            legendSvg.attr('width', legendWidth).attr('height', legendHeight);
            // Create the svg:defs element and the main gradient definition.
            var svgDefs = legendSvg.append('defs');
            var mainGradient = svgDefs.append('linearGradient')
                    .attr('id', 'mainGradient').attr("x1", "0%").attr("y1", "0%").attr("x2", "0%").attr("y2", "100%");

            //height of each row in the createHeatmap
            var h = 10;
            //width of each column in the createHeatmap
            var w = 100;
            //attach a SVG node to the document
            //height and width defined by the row/column lengths
            var width = (w * singlecols.length) + 100;
            //d3.select("body").append("div").attr("id","createHeatmap");
            var loadContent = [];
            // Main Row Tree SVG Information
            var treeWidth = (w * singlecols.length), treeHeight = h * singlerows.length;
            // Main Column Tree SVG Information
            var colTreeWidth = width-25, colTreeHeight = 80;
            var mySVG = d3.select("#" + blockId).select("div.block-display")
                    .append("svg")
                    .attr("viewBox", "0 0 900 1100")
                    .attr("width","100%")
            var heatmapG = mySVG.append('g')
                    .attr("transform", "translate(400, 50)")
                    .attr("id", heatmapId)
            //.attr("transform", "translate(500, 0)")
            var colTreeG = mySVG
                    .append("g")
                    .attr("id", colTreeId)
                    .attr("transform", "translate(430, 0)")
            //.attr("width", colTreeWidth)
            //.attr("height", colTreeHeight)
            //.attr("transform", "translate(-100, 0)")
            var treeG = mySVG
                    .append("g")
                    .attr("id", treeId)
                    .attr("transform", "translate(50, 100)")
                    .attr("height", treeHeight)
            //.attr("width", treeWidth)

            //.attr("transform", "translate(40, 0)");

            var titleDiv = d3.select("body").select("#titleDiv").attr("class", "title");
            titleDiv.append("p").append("font").attr("size", "30").text("Gene Expression");
            titleDiv.append("p").append("font").attr("size", "24").text("Heatmap and Dendrogram (Hierarchy clustering)");
            //d3.select("body").select("#createHeatmap").append("h1").text("Main createHeatmap");

            //generate the Heatmap
            heatmapRow = heatmapG.selectAll(".heatmap")
                    .data(data)
                    .enter().append("g");

            // Draw the Heatmap
            heatmapRects = heatmapRow
                    .selectAll(".rect")
                    .data(function (d) {
                        return d;
                    }).enter().append("svg:rect")
                    .attr('width', w)
                    .attr('height', h)
                    .attr('x', function (d) {
                        return (d[2] * w) + 75;
                    })
                    .attr('y', function (d) {
                        return (d[1] * h) + 50;

                    })
                    .style('fill', function (d) {
                        return colorScale(d[0]);
                    });

            //label columns (Condition name)
            var columnLabel = heatmapG.selectAll(".colLabel")
                    .data(cols)
                    .enter().append('svg:text')
                    .attr('x', function (d, i) {
                        return ((i + 0.5) * w) + 75;
                    })
                    .attr('y', function (d, i) {
                        return 30;
                    })
                    .attr('class', 'label')
                    .style('text-anchor', 'middle')
                    .text(function (d) {
                        return d;
                    });

            columnLabel
                    .on("mouseover", function () {
                        d3.select(this).style("font-weight", "bold").style("font-size", "18")
                    })
                    .on("mouseout", function () {
                        d3.select(this).style("font-weight", "").style("font-size", "12")
                    });


            //label row (Gene name)
            var rowLabel = heatmapG.selectAll(".rowLabel")
                    .data(rows)
                    .enter().append('svg:text')
                    .attr('x', 30)
                    .attr('y', function (d, i) {
                        return ((i + 3.5) * h) + 25;
                    })
                    .attr('class', 'label')
                    .style('text-anchor', 'middle')
                    .text(function (d) {
                        return d;
                    });

            rowLabel
                    .on("mouseover", function () {
                        d3.select(this).style("font-weight", "bold").style("font-size", "18")
                    })
                    .on("mouseout", function () {
                        d3.select(this).style("font-weight", "").style("font-size", "12")
                    });
            //expression value label
            var expLab = d3.select("body")
                    .append('div')
                    .style('height', 23)
                    .style('text-align', 'center')
                    .style('background', 'FFE53B')
                    .style('opacity', 0.8)
                    .style('top', 0)
                    .style('padding', 10)
                    .style('left', 40)
                    .style('display', 'none');


            //createHeatmap mouse events
            heatmapRow
                    .on('mouseover', function (d, i) {
                        d3.select(this)
                                .attr('stroke-width', 1)
                                .attr('stroke', 'black')

                        output = '<b>' + rows[i] + '</b><br>';
                        for (var j = 0, count = data[i].length; j < count; j++) {
                            output += data[i][colSeq[j]][0] + ", ";
                        }

                        expLab
                                .style('top', (i * h))
                                .style('display', 'block')
                                .html(output.substring(0, output.length - 3));
                    })
                    .on('mouseout', function (d, i) {
                        d3.select(this)
                                .attr('stroke-width', 0)
                                .attr('stroke', 'none')

                        expLab
                                .style('display', 'none')
                    })

            visualizer.makeTree(currentCluster, treeId, "tree", treeHeight);
            visualizer.makeColTree(currentCluster, colTreeId, "main", colTreeWidth);
        },
        makeTree: function (clusterName, treeId, treeType, makeTreeHeight) {
            var g = d3.select("#" + treeId);
            console.log(g);
            var tree = d3.cluster().size([makeTreeHeight, 280]);
            //This code help to find the parent id in this hierarchy, so change this part.
            var stratify = d3.stratify().parentId(function (d) {
                return d.id.substring(0, d.id.lastIndexOf("."));
            });
            var path = "";
            if (treeType == "tree") {
                path = blockManager.basicUrl + clusterName + "tree.csv";
            } else if (treeType == "subTree") {
                path = blockManager.basicUrl + "subtree.csv";
            }
            //console.log(path);

            d3.csv(path, function (error, data) {
                //console.log("#"+treeId);
                if (error) throw error;

                var root = stratify(data);
                tree(root);

                var link = g.selectAll(".link").data(root.descendants().slice(1))
                        .enter().append("path").attr("class", "link").attr("d", function (d) {
                            return "M" + d.y + "," + d.x
                                    + " L " + d.parent.y + " " + d.x + " L " + d.parent.y + " " + d.parent.x;

                        });

                link
                        .on("mouseover", function (d, i) {
                            d3.select(d3.select(this)._groups[0][0]).style("stroke", "black").style("stroke-width", 2)
                        })
                        .on("mouseout", function () {
                            d3.select(this).style("stroke", "").style("stroke-width", "")
                        });


                var node = g.selectAll(".node")
                        .data(root.descendants())
                        .enter().append("g")
                        .attr("class", function (d) {
                            return "node" + (d.children ? " node--internal" : " node--leaf");
                        })
                        .attr("transform", function (d) {
                            return "translate(" + d.y + "," + d.x + ")";
                        })

                node.append("circle").attr("r", 2.5)
                        .attr("id", "node")
                        .on("mouseover", function (d) {
                            d3.select(this).attr("r", 5)
                        })
                        .on("mouseout", function () {
                            d3.select(this).attr("r", 2.5)
                        })
                        .on("click", function (d) {
                            subSVG.selectAll("g").remove();
                            subSVG.selectAll("text").remove();
                            var smallHeatmapURL = basicUrl + "subcreateHeatmap.html";
                            var id = d.id.substring(d.id.lastIndexOf(".") + 1);
                            smallHeatmapURL = smallHeatmapURL + "?nodeId=" + id + "&length=" + rowlength + "&clusterName=" + clusterName;

                            var httpRequest;
                            if (window.XMLHttpRequest) { // 모질라, 사파리등 그외 브라우저, ...
                                httpRequest = new XMLHttpRequest();
                            } else if (window.ActiveXObject) { // IE 8 이상
                                httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
                            }
                            httpRequest.onreadystatechange = function () {
                                if (httpRequest.readyState === 4) {
                                    visualizer.createHeatmap(subdata, subcols, subrows, subSVG, "sub");
                                }

                            };
                            httpRequest.open('GET', smallHeatmapURL);
                            console.log(smallHeatmapURL);
                            httpRequest.send();
                            location.reload();
                        });

                node.append("text").attr("dy", 3).attr("x", function (d) {
                    return d.children ? -8 : 8;
                })
                        .style("text-anchor", function (d) {
                            return d.children ? "end" : "start";
                        })
                        .text(function (d) {
                            return d.id.substring(d.id.lastIndexOf(".") + 1);
                        })
                        .on("mouseover", function () {
                            d3.select(this).style("font-weight", "bold")
                        })
                        .on("mouseout", function () {
                            d3.select(this).style("font-weight", "")
                        })
            });
        },
        makeColTree: function (clusterName, treeId, treeType, treeWidth) {
            console.log(treeId)
            console.log(treeWidth);
            if (treeType == "main") {
                var g = d3.select("#" + treeId);
                var path = blockManager.basicUrl + "/" + clusterName + "coltree.csv";
            } else if (treeType == "sub") {
                var g = d3.select("#" + treeId);
                var path = blockManager.basicUrl + "subcoltree.csv"
            }

            var tree = d3.cluster().size([treeWidth, 50]);
            var stratify = d3.stratify().parentId(function (d) {
                return d.id.substring(0, d.id.lastIndexOf("."));
            });

            d3.csv(path, function (error, data) {
                if (error) throw error;

                var root = stratify(data);
                tree(root);
                var link = g.selectAll(".link").data(root.descendants().slice(1))
                        .enter().append("path").attr("class", "link").attr("d", function (d) {
                            return "M" + d.x + "," + d.y
                                    + " L " + d.x + " " + d.parent.y + " L " + d.parent.x + " " + d.parent.y;
                        });
            });
        }
    };
</script>

<script>
    // TODO 2.1 크러스터 정보 호출
    // TODO 2.2 Data 파일 업로드
    // TOdo 2.3 D3용 Block 데이터 호출

    // 좌측 기본 분석 메뉴 액션 핸들러
    var basicMenuHandler = {
        init: function () {
            // 메뉴 상태 초기화
        },
        toggleMenu: function () {

        },
        loadBlock: function () {
            // 서버에서 D3 용 데이터를 가져옴
        },
        uploadData: function () {
            // Ajax 파일 업로드 처리
        },
        showCluster: function () {
            // 가능한 클러스터 리스트를 서버에서 호출후 Selectbox로 생성
        },
        checkGo: function () {
            // 블록 추가 가능 여부 확인
        },
        pushGo: function () {
            // Block, Data, Cluster 정보를 바탕으로 중앙 메인 화면에 신규 D3 블록 생성
        }
    };
</script>

<script>
    // 우측 분석 메뉴 액션 핸들러
    var advanceMenuHandler = {};
</script>
<script>
    // TODO 테스트용 임시 코드
    $(document).ready(function () {
        visualizer.createNetworkGraph();
        visualizer.createBarGraph();
        $('#toggle_bar_table').on('change', function (e) {
            $('div.bar-table').toggle();
            $('div.bar-graph').toggle();
        });
    });
    $(window).scroll(function () {
        $('nav').animate({top: $(window).scrollTop() + "px"}, {queue: false, duration: 350});
        //$('.frequency-panel').animate({top: $(window).scrollTop() + "px"}, {queue: false, duration: 350});
        //$('div.network-panel').animate({top: $(window).scrollTop() + "px"}, {queue: false, duration: 350});
    });
</script>
<script>
    // 블록 관리
    var blockManager = {
        basicUrl: "",
        blockMap: {},
        init: function () {
            this.blockMap = {};
        },
        delBlock: function (blockId) {
            var $block = $('#' + blockId);
            $block.remove();
            delete this.blockMap[blockId];
            return this.blockMap;
        },
        addBlock: function () {
            // 블록 생성
            var blockId = this.getBlockId();
            var blockSvgId = blockId + "-svg";
            var $block = $('<div class="thumbnail col-md-6 block display text-right">' +
                    '<a class="pull-left block-title"></a>' +
                    '<a href="#" class="edit-block"><i class="glyphicon glyphicon-cog"></i> </a>' +
                    '<a href="#" class="del-block"> <i class="glyphicon glyphicon-remove"></i></a>' +
                    '<div class="caption">' +
                    '<div class="block-display" style="display: none" ></div>' +
                    '<div class="block-edit">' +
                    '<p><input type="text" class="form-control" placeholder="BLOCK NAME..."></p>' +
                    '<p><label>- Cluster</label><select class="selectpicker" data-width="100%" data-style="btn-primary"> <option>Method 1</option> <option>Method 2</option> <option>Method 3</option> </select> </p>' +
                    '<p><label>- Data</label><input id="input-folder-1" type="file"class="file"></p>' +
                    '<p><a class="btn btn-success btn-block btn-block-done">Done</a></p>' +
                    '</div></div></div>');
            $block.attr('id', blockId);
            $block.find('a.del-block').on('click', function (e) {
                blockManager.delBlock(blockId)
            });
            console.log($block.find('svg').get(0));
            var $blockDisplay = $block.find('div.block-display');
            var $blockEdit = $block.find('div.block-edit');
            $block.find('a.btn-block-done').on('click', function (e) {
                blockManager.selectType(currentClusterType);
                //currentColor = colorScale;
                //legend(colorScale);
                visualizer.createHeatmap(currentData, currentCols, currentRows, blockId, "main");
                //makeTree(currentCluster, "tree", treeHeight);
                //makeColTree(currentCluster, "main");
                $blockDisplay.toggle();
                $blockEdit.toggle();
            });
            $block.find('a.edit-block').on('click', function (e) {
                $blockDisplay.toggle();
                $blockEdit.toggle();
            });
            $block.resizable({
                grid: [1, 10000],
                containment: "#content"
            });
            // 화면 갱신
            $('div.main').append($block);
            $block.hide().show('normal');
            $('.selectpicker').selectpicker('refresh');
            $("input.file").fileinput();
            this.blockMap[blockId] = $block;
            return $block;
        },
        getBlockId: function () {
            // 고유 ID 부여
            var d = new Date();
            return 'block-' + d.getTime();
        },
        selectType: function (clusterType) {
            if (clusterType == "single") {
                currentData = singledata, currentCols = singlecols, currentRows = singlerows, currentCluster = clusterType;
            } else if (clusterType == "complete") {
                currentData = completedata, currentCols = completecols, currentRows = completerows, currentCluster = clusterType;
            } else if (clusterType == "average") {
                currentData = averagedata, currentCols = averagecols, currentRows = averagerows, currentCluster = clusterType;
            } else if (clusterType == "weighted") {
                currentData = weighteddata, currentCols = weightedcols, currentRows = weightedrows, currentCluster = clusterType;
            } else if (clusterType == "centroid") {
                currentData = centroiddata, currentCols = centroidcols, currentRows = centroidrows, currentCluster = clusterType;
            } else if (clusterType == "median") {
                currentData = mediandata, currentCols = mediancols, currentRows = medianrows, currentCluster = clusterType;
            } else if (clusterType == "ward") {
                currentData = warddata, currentCols = wardcols, currentRows = wardrows, currentCluster = clusterType;
            }
        }
    };
</script>
</body>
</html>